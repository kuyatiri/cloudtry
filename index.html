<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Premium IPTV</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.6/shaka-player.compiled.js"></script>

<style>
:root {
    --bg: #0b0f1a;
    --panel: #111827;
    --hover: #1f2937;
    --accent: #e50914;
}

* { box-sizing: border-box; }

body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: var(--bg);
    color: white;
    display: grid;
    grid-template-columns: 300px 1fr;
    height: 100vh;
    overflow: hidden;
}

/* Sidebar */
#sidebar {
    background: var(--panel);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

#search {
    padding: 12px;
    border: none;
    outline: none;
    background: #0f172a;
    color: white;
    font-size: 14px;
}

#channels {
    flex: 1;
    overflow-y: auto;
}

.group-title {
    padding: 10px;
    font-size: 12px;
    opacity: 0.6;
    text-transform: uppercase;
}

.channel {
    display: flex;
    align-items: center;
    padding: 10px;
    cursor: pointer;
    transition: 0.2s;
}

.channel:hover { background: var(--hover); }

.channel.active {
    background: var(--accent);
}

.channel img {
    width: 40px;
    height: 40px;
    object-fit: contain;
    margin-right: 10px;
    border-radius: 6px;
}

/* Main */
#main {
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
}

video {
    width: 95%;
    max-width: 1200px;
    border-radius: 14px;
    background: black;
}

/* Mobile */
#menuBtn {
    display: none;
    position: fixed;
    top: 15px;
    left: 15px;
    background: var(--accent);
    border: none;
    padding: 10px 14px;
    color: white;
    z-index: 200;
    border-radius: 8px;
}

#overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 100;
}

@media (max-width: 900px) {
    body { grid-template-columns: 1fr; }

    #sidebar {
        position: fixed;
        width: 280px;
        height: 100%;
        left: -280px;
        transition: 0.3s;
        z-index: 150;
    }

    #sidebar.active { left: 0; }

    #menuBtn { display: block; }

    #overlay.active { display: block; }
}
</style>
</head>

<body>

<button id="menuBtn">☰</button>
<div id="overlay"></div>

<div id="sidebar">
    <input type="text" id="search" placeholder="Search channels...">
    <div id="channels"></div>
</div>

<div id="main">
    <video id="video" controls autoplay></video>
</div>

<script>
const video = document.getElementById('video');
const player = new shaka.Player(video);
const sidebar = document.getElementById('sidebar');
const overlay = document.getElementById('overlay');
const menuBtn = document.getElementById('menuBtn');
const channelsDiv = document.getElementById('channels');
const searchInput = document.getElementById('search');

let channels = [];
let selectedIndex = 0;

menuBtn.onclick = () => {
    sidebar.classList.toggle('active');
    overlay.classList.toggle('active');
};

overlay.onclick = () => {
    sidebar.classList.remove('active');
    overlay.classList.remove('active');
};

async function loadPlaylist() {
    const res = await fetch('playlist.m3u');
    const text = await res.text();
    parseM3U(text);
}

function parseM3U(data) {
    const lines = data.split('\n');

    for (let i = 0; i < lines.length; i++) {
        if (lines[i].startsWith('#EXTINF')) {

            const name = lines[i].split(',')[1] || "Channel";
            const groupMatch = lines[i].match(/group-title="(.*?)"/);
            const logoMatch = lines[i].match(/tvg-logo="(.*?)"/);

            // ❌ Skip if no group or group is "Other"
            if (!groupMatch || groupMatch[1].toLowerCase() === "other") continue;

            const group = groupMatch[1];
            const url = lines[i + 5] || lines[i + 1];

            let keyLine = lines.slice(i, i+6).find(l => l.includes('license_key'));
            let keyId = "", key = "";

            if (keyLine) {
                let keys = keyLine.split('=')[1].split(':');
                keyId = keys[0];
                key = keys[1];
            }

            channels.push({
                name,
                group,
                logo: logoMatch ? logoMatch[1] : "",
                url,
                keyId,
                key
            });
        }
    }

    renderChannels();

    // ✅ AUTO PLAY FIRST CHANNEL
    if (channels.length > 0) {
        playChannel(0);
    }
}

function renderChannels(filter="") {
    channelsDiv.innerHTML = "";
    let lastGroup = "";

    channels
        .filter(c => c.name.toLowerCase().includes(filter.toLowerCase()))
        .forEach((c, index) => {

        if (c.group !== lastGroup) {
            let groupTitle = document.createElement('div');
            groupTitle.className = "group-title";
            groupTitle.innerText = c.group;
            channelsDiv.appendChild(groupTitle);
            lastGroup = c.group;
        }

        let div = document.createElement('div');
        div.className = "channel";
        div.innerHTML = `
            ${c.logo ? `<img src="${c.logo}">` : ""}
            <span>${c.name}</span>
        `;

        div.onclick = () => playChannel(index);

        channelsDiv.appendChild(div);
    });
}

async function playChannel(index) {
    selectedIndex = index;
    const c = channels[index];

    document.querySelectorAll('.channel').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.channel')[index]?.classList.add('active');

    sidebar.classList.remove('active');
    overlay.classList.remove('active');

    await player.unload();

    player.configure({
        drm: {
            clearKeys: {
                [c.keyId]: c.key
            }
        }
    });

    await player.load(c.url);
}

/* Search */
searchInput.addEventListener("input", e => {
    renderChannels(e.target.value);
});

/* Arrow navigation */
document.addEventListener("keydown", e => {
    if (e.key === "ArrowDown") {
        selectedIndex = (selectedIndex + 1) % channels.length;
        playChannel(selectedIndex);
    }
    if (e.key === "ArrowUp") {
        selectedIndex = (selectedIndex - 1 + channels.length) % channels.length;
        playChannel(selectedIndex);
    }
});

loadPlaylist();
</script>


</body>
</html>
