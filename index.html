<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Premium IPTV</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.6/shaka-player.compiled.js"></script>

<style>
:root {
    --bg: #0b0f1a;
    --panel: #111827;
    --hover: #1f2937;
    --accent: #e50914;
}

* { box-sizing: border-box; }

body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: var(--bg);
    color: white;
    min-height: 100dvh; /* dynamic viewport fix */
    display: grid;
    grid-template-columns: 300px 1fr;
}

/* Sidebar */
#sidebar {
    background: var(--panel);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

#search {
    padding: 12px;
    border: none;
    outline: none;
    background: #0f172a;
    color: white;
    font-size: 14px;
}

#channels {
    flex: 1;
    overflow-y: auto;
}

.group-title {
    padding: 10px;
    font-size: 12px;
    opacity: 0.6;
    text-transform: uppercase;
}

.channel {
    display: flex;
    align-items: center;
    padding: 10px;
    cursor: pointer;
    transition: 0.2s;
}

.channel:hover { background: var(--hover); }

.channel.active {
    background: var(--accent);
}

.channel img {
    width: 40px;
    height: 40px;
    object-fit: contain;
    margin-right: 10px;
    border-radius: 6px;
}

.video-wrapper {
    width: 100%;
    max-width: 1200px;
    aspect-ratio: 16 / 9;
    background: black;
    border-radius: 14px;
    overflow: hidden;
    box-shadow: 0 15px 50px rgba(0,0,0,0.6);
    display: flex;
    justify-content: center;
    align-items: center;
}

.video-wrapper video {
    width: 100%;
    height: 100%;
    object-fit: contain; 
}

/* Main */
#main {
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
}

video {
    width: 95%;
    max-width: 1200px;
    border-radius: 14px;
    background: black;
}

/* Mobile */
#menuBtn {
    display: none;
    position: fixed;
    top: 15px;
    left: 15px;
    background: var(--accent);
    border: none;
    padding: 10px 14px;
    color: white;
    z-index: 200;
    border-radius: 8px;
}

#overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 100;
}

@media (max-width: 900px) {

    body {
        display: flex;
        flex-direction: column;
    }

    #main {
        order: 1;
        width: 100%;
        padding: 0;
    }

    .video-wrapper {
        width: 100%;
        max-width: 100%;
        border-radius: 0;
    }

    #sidebar {
        position: fixed;
        width: 280px;
        height: 100%;
        left: -280px;
        top: 0;
        transition: 0.3s;
        z-index: 150;
    }

    #sidebar.active {
        left: 0;
    }

    #menuBtn {
        display: block;
    }

    #overlay.active {
        display: block;
    }
}

</style>
</head>

<body>

<button id="menuBtn">☰</button>
<div id="overlay"></div>

<div id="sidebar">
    <input type="text" id="search" placeholder="Search channels...">
    <div id="channels"></div>
</div>

<div id="main">
    <div class="video-wrapper">
        <video id="video" controls autoplay></video>
    </div>
</div>


<script>
const PLAYLIST_URL = "https://premiumiptv.tiri-piso-wifi.workers.dev/playlist?token=mysecret123";

const video = document.getElementById('video');
const player = new shaka.Player(video);
const sidebar = document.getElementById('sidebar');
const overlay = document.getElementById('overlay');
const menuBtn = document.getElementById('menuBtn');
const channelsDiv = document.getElementById('channels');
const searchInput = document.getElementById('search');

let channels = [];
let selectedIndex = 0;

menuBtn.onclick = () => {
    sidebar.classList.toggle('active');
    overlay.classList.toggle('active');
};

overlay.onclick = () => {
    sidebar.classList.remove('active');
    overlay.classList.remove('active');
};

async function loadPlaylist() {
    const res = await fetch(PLAYLIST_URL);
    const text = await res.text();
    parseM3U(text);
}

function parseM3U(data) {
    const lines = data.split('\n');
    let currentChannel = null;

    lines.forEach(line => {

        line = line.trim();

        if (line.startsWith('#EXTINF')) {

            const name = line.split(',')[1] || "Channel";
            const groupMatch = line.match(/group-title="(.*?)"/);
            const logoMatch = line.match(/tvg-logo="(.*?)"/);

            if (!groupMatch || groupMatch[1].toLowerCase() === "other") {
                currentChannel = null;
                return;
            }

            currentChannel = {
                name,
                group: groupMatch[1],
                logo: logoMatch ? logoMatch[1] : "",
                keyId: "",
                key: "",
                url: ""
            };
        }

        else if (line.includes('license_key') && currentChannel) {
            const keys = line.split('=')[1].split(':');
            currentChannel.keyId = keys[0];
            currentChannel.key = keys[1];
        }

        else if (line && !line.startsWith('#') && currentChannel) {
            currentChannel.url = line;
            channels.push(currentChannel);
            currentChannel = null;
        }

    });

    renderChannels();

    // ✅ AUTO PLAY FIRST CHANNEL
    if (channels.length > 0) {
        playChannel(0);
    }
}

function renderChannels(filter="") {
    channelsDiv.innerHTML = "";
    let lastGroup = "";

    channels
        .filter(c => c.name.toLowerCase().includes(filter.toLowerCase()))
        .forEach((c, index) => {

        if (c.group !== lastGroup) {
            let groupTitle = document.createElement('div');
            groupTitle.className = "group-title";
            groupTitle.innerText = c.group;
            channelsDiv.appendChild(groupTitle);
            lastGroup = c.group;
        }

        let div = document.createElement('div');
        div.className = "channel";
        div.innerHTML = `
            ${c.logo ? `<img src="${c.logo}">` : ""}
            <span>${c.name}</span>
        `;

        div.onclick = () => playChannel(index);

        channelsDiv.appendChild(div);
    });
}

async function playChannel(index) {
    selectedIndex = index;
    const c = channels[index];

    document.querySelectorAll('.channel').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.channel')[index]?.classList.add('active');

    sidebar.classList.remove('active');
    overlay.classList.remove('active');

    await player.unload();

    // ✅ Use keys parsed from playlist
    player.configure({
        drm: {
            clearKeys: {
                [c.keyId]: c.key
            }
        }
    });

    await player.load(c.url);
}


/* Search */
searchInput.addEventListener("input", e => {
    renderChannels(e.target.value);
});

/* Arrow navigation */
document.addEventListener("keydown", e => {
    if (e.key === "ArrowDown") {
        selectedIndex = (selectedIndex + 1) % channels.length;
        playChannel(selectedIndex);
    }
    if (e.key === "ArrowUp") {
        selectedIndex = (selectedIndex - 1 + channels.length) % channels.length;
        playChannel(selectedIndex);
    }
});

loadPlaylist();
</script>



</body>
</html>









