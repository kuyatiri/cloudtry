<script>
const video = document.getElementById('video');
const player = new shaka.Player(video);
const sidebar = document.getElementById('sidebar');
const overlay = document.getElementById('overlay');
const menuBtn = document.getElementById('menuBtn');
const channelsDiv = document.getElementById('channels');
const searchInput = document.getElementById('search');

let channels = [];
let selectedIndex = 0;

menuBtn.onclick = () => {
    sidebar.classList.toggle('active');
    overlay.classList.toggle('active');
};

overlay.onclick = () => {
    sidebar.classList.remove('active');
    overlay.classList.remove('active');
};

async function loadPlaylist() {
    const res = await fetch('playlist.m3u');
    const text = await res.text();
    parseM3U(text);
}

function parseM3U(data) {
    const lines = data.split('\n');

    for (let i = 0; i < lines.length; i++) {
        if (lines[i].startsWith('#EXTINF')) {

            const name = lines[i].split(',')[1] || "Channel";
            const groupMatch = lines[i].match(/group-title="(.*?)"/);
            const logoMatch = lines[i].match(/tvg-logo="(.*?)"/);

            // ❌ Skip if no group or group is "Other"
            if (!groupMatch || groupMatch[1].toLowerCase() === "other") continue;

            const group = groupMatch[1];
            const url = lines[i + 5] || lines[i + 1];

            let keyLine = lines.slice(i, i+6).find(l => l.includes('license_key'));
            let keyId = "", key = "";

            if (keyLine) {
                let keys = keyLine.split('=')[1].split(':');
                keyId = keys[0];
                key = keys[1];
            }

            channels.push({
                name,
                group,
                logo: logoMatch ? logoMatch[1] : "",
                url,
                keyId,
                key
            });
        }
    }

    renderChannels();

    // ✅ AUTO PLAY FIRST CHANNEL
    if (channels.length > 0) {
        playChannel(0);
    }
}

function renderChannels(filter="") {
    channelsDiv.innerHTML = "";
    let lastGroup = "";

    channels
        .filter(c => c.name.toLowerCase().includes(filter.toLowerCase()))
        .forEach((c, index) => {

        if (c.group !== lastGroup) {
            let groupTitle = document.createElement('div');
            groupTitle.className = "group-title";
            groupTitle.innerText = c.group;
            channelsDiv.appendChild(groupTitle);
            lastGroup = c.group;
        }

        let div = document.createElement('div');
        div.className = "channel";
        div.innerHTML = `
            ${c.logo ? `<img src="${c.logo}">` : ""}
            <span>${c.name}</span>
        `;

        div.onclick = () => playChannel(index);

        channelsDiv.appendChild(div);
    });
}

async function playChannel(index) {
    selectedIndex = index;
    const c = channels[index];

    document.querySelectorAll('.channel').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.channel')[index]?.classList.add('active');

    sidebar.classList.remove('active');
    overlay.classList.remove('active');

    await player.unload();

    player.configure({
        drm: {
            clearKeys: {
                [c.keyId]: c.key
            }
        }
    });

    await player.load(c.url);
}

/* Search */
searchInput.addEventListener("input", e => {
    renderChannels(e.target.value);
});

/* Arrow navigation */
document.addEventListener("keydown", e => {
    if (e.key === "ArrowDown") {
        selectedIndex = (selectedIndex + 1) % channels.length;
        playChannel(selectedIndex);
    }
    if (e.key === "ArrowUp") {
        selectedIndex = (selectedIndex - 1 + channels.length) % channels.length;
        playChannel(selectedIndex);
    }
});

loadPlaylist();
</script>
