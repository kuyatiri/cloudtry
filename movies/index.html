<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TIRI PISO WIFI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="portal_styles.css">
</head>
<body>
  <header>
    <h1>TIRI PISO WIFI Movie Streaming Portal</h1>
  </header>

  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="Search for a movie...">
  </div>

  <div class="section-title">Search Results</div>
  <div id="searchResults" class="movie-grid" style="display: none;"></div>

  <div class="section-title">Popular Movies</div>
  <div id="popularMovies" class="movie-grid"></div>

  <div class="section-title">Watch History</div>
  <div id="watchHistory" class="movie-grid"></div>

  <script>
    const apiKey = '840070ae68682e88ec98c835bf40c5e9';
    const popularContainer = document.getElementById('popularMovies');
    const historyContainer = document.getElementById('watchHistory');
    const searchResultsContainer = document.getElementById('searchResults');
    const searchInput = document.getElementById('searchInput');

    // Placeholder image for missing posters (add this file to your project or change the path)
    const PLACEHOLDER_POSTER = 'default-poster.png';

    function createMovieCard(movie) {
      const card = document.createElement('div');
      card.className = 'movie-card';
      card.onclick = () => {
        saveToHistory(movie);
        // pass title as well so provider picker can use it to find streams
        const safeTitle = encodeURIComponent(movie.title || movie.name || '');
        window.location.href = `movie.html?id=${movie.id}&title=${safeTitle}`;
      };

      const img = document.createElement('img');
      img.alt = movie.title || 'Movie poster';
      img.src = movie.poster_path ? `https://image.tmdb.org/t/p/w500${movie.poster_path}` : PLACEHOLDER_POSTER;
      img.onerror = () => { img.src = PLACEHOLDER_POSTER; };

      const title = document.createElement('h4');
      title.textContent = movie.title || movie.name || 'Untitled';

      card.appendChild(img);
      card.appendChild(title);
      return card;
    }

    function loadPopularMovies() {
      fetch(`https://api.themoviedb.org/3/movie/popular?api_key=${apiKey}`)
        .then(res => {
          if (!res.ok) throw new Error('Failed to load popular movies');
          return res.json();
        })
        .then(data => {
          popularContainer.innerHTML = '';
          data.results.forEach(movie => {
            popularContainer.appendChild(createMovieCard(movie));
          });
        })
        .catch(err => {
          console.error('Popular movies error:', err);
          popularContainer.innerHTML = '<p class="error">Could not load popular movies.</p>';
        });
    }

    function saveToHistory(movie) {
      try {
        let historyList = JSON.parse(localStorage.getItem('watchHistory')) || [];
        historyList = historyList.filter(m => m.id !== movie.id);
        historyList.unshift(movie);
        if (historyList.length > 10) historyList.pop();
        localStorage.setItem('watchHistory', JSON.stringify(historyList));
      } catch (e) {
        console.error('saveToHistory error', e);
      }
    }

    function loadWatchHistory() {
      historyContainer.innerHTML = '';
      const historyList = JSON.parse(localStorage.getItem('watchHistory')) || [];
      historyList.forEach(movie => {
        historyContainer.appendChild(createMovieCard(movie));
      });
      if (!historyList.length) {
        historyContainer.innerHTML = '<p class="muted">No watch history yet.</p>';
      }
    }

    function performSearch(query) {
      const trimmed = (query || '').trim();
      if (!trimmed) {
        searchResultsContainer.style.display = 'none';
        searchResultsContainer.innerHTML = '';
        return;
      }

      searchResultsContainer.style.display = '';
      searchResultsContainer.innerHTML = '<p class="muted">Searchingâ€¦</p>';

      fetch(`https://api.themoviedb.org/3/search/movie?api_key=${apiKey}&query=${encodeURIComponent(trimmed)}`)
        .then(res => {
          if (!res.ok) throw new Error('Search fetch failed');
          return res.json();
        })
        .then(data => {
          searchResultsContainer.innerHTML = '';
          if (!data.results || data.results.length === 0) {
            searchResultsContainer.innerHTML = '<p class="muted">No results found.</p>';
            return;
          }
          data.results.forEach(movie => {
            searchResultsContainer.appendChild(createMovieCard(movie));
          });
        })
        .catch(err => {
          console.error('Search error:', err);
          searchResultsContainer.innerHTML = '<p class="error">Search failed. Try again later.</p>';
        });
    }

    // Enter key triggers a search
    searchInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        performSearch(e.target.value);
      }
    });

    // Optional: quick search on input after small debounce
    let debounceTimer = null;
    searchInput.addEventListener('input', function(e) {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        const val = e.target.value;
        if (!val.trim()) {
          searchResultsContainer.style.display = 'none';
          searchResultsContainer.innerHTML = '';
        }
      }, 600);
    });

    // Initial load
    loadPopularMovies();
    loadWatchHistory();
  </script>
</body>
</html>
