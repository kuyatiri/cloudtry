<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Premium IPTV</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.6/shaka-player.compiled.js"></script>

<style>
:root {
    --bg: #0f172a;
    --bg-soft: #111827;
    --panel: rgba(255,255,255,0.04);
    --border: rgba(255,255,255,0.08);
    --accent: #7c3aed;
    --accent-glow: rgba(124,58,237,0.6);
    --text-muted: rgba(255,255,255,0.6);
}

* {
    box-sizing: border-box;
}

body {
    margin: 0;
    font-family: 'Inter', Arial, sans-serif;
    background: radial-gradient(circle at top left, #1e293b, #0f172a 60%);
    color: white;
    min-height: 100dvh;
    display: flex;
}

/* Sidebar */
#sidebar {
    z-index: 100;
    width: 300px;
    backdrop-filter: blur(20px);
    background: var(--panel);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    transition: 0.3s ease;
    height: 100vh;
    height: 100dvh;
}

/* Search */
#search {
    margin: 15px;
    padding: 12px 14px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: var(--bg-soft);
    color: white;
    font-size: 14px;
    transition: 0.2s;
}

header {
    height: 70px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    background: linear-gradient(90deg, #1a1f3c, #0f172a);
}

#search:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px var(--accent-glow);
}

/* Channels */
#channels {
    flex: 1;
    overflow-y: auto;
    padding: 5px 10px 20px 10px;
}

.group-title {
    padding: 10px 8px;
    font-size: 11px;
    letter-spacing: 1px;
    color: var(--text-muted);
    text-transform: uppercase;
}

.channel {
    display: flex;
    align-items: center;
    padding: 10px;
    border-radius: 12px;
    cursor: pointer;
    transition: 0.25s ease;
    margin-bottom: 4px;
}

.channel:hover {
    background: rgba(255,255,255,0.05);
    transform: translateX(3px);
}

.channel.active {
    background: var(--accent);
    box-shadow: 0 0 15px var(--accent-glow);
}

.channel img {
    width: 38px;
    height: 38px;
    object-fit: contain;
    margin-right: 12px;
    border-radius: 8px;
    background: rgba(255,255,255,0.05);
    padding: 4px;
}

.channel span {
    font-size: 14px;
}

/* Main */
#main {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: 0px;
}

/* Modern Video Card */
.video-wrapper {
    width: 100%;
    max-width: 1000px;
    aspect-ratio: 16 / 9;
    background: black;
    border-radius: 20px;
    overflow: hidden;
    box-shadow:
        0 25px 60px rgba(0,0,0,0.6),
        0 0 40px rgba(124,58,237,0.2);
    transition: 0.3s ease;
    position: relative;
}

.custom-controls {
    position: absolute;
    bottom: 15px;
    right: 15px;
    display: flex;
    gap: 10px;
}

.custom-controls button {
    width: 45px;
    height: 45px;
    border-radius: 12px;
    border: none;
    background: rgba(0,0,0,0.6);
    color: white;
    font-size: 18px;
    cursor: pointer;
    backdrop-filter: blur(10px);
    transition: 0.2s;
}

.custom-controls button:hover {
    background: rgba(255,255,255,0.2);
}

.video-wrapper:hover {
    transform: scale(1.01);
}

.video-wrapper video {
    width: 100%;
    height: 100%;
    object-fit: contain;
}

/* Menu Button */
#menuBtn {
    position: absolute;   /* ðŸ‘ˆ change from fixed */
    left: 5px;
    top: 30px;
    transform: translateY(-50%);
    z-index: 10;
    width: 50px;
    height: 50px;
    border-radius: 16px;
}

.player-container {
    width: 100%;
    max-width: 1000px;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.app-title {
    font-size: 22px;
    font-weight: 600;
    margin-bottom: 20px;
    letter-spacing: 1px;
    background: linear-gradient(90deg, #7c3aed, #22d3ee);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-align: center;
}


/* Overlay */
#overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(5px);
    z-index: 90;
}

#epgContainer {
    margin-top: 20px;
    padding: 15px;
    background: #111827;
    border-radius: 12px;
    width: 100%;
    max-width: 1100px;
}

#epgNow {
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 5px;
}

#epgNext {
    font-size: 14px;
    opacity: 0.8;
}


/* Mobile */
@media (max-width: 900px) {

    body {
        display: flex;
        flex-direction: column;
    }

    header {
        flex-shrink: 0;
    }

    #main {
        flex: 1;
        padding: 0;
        align-items: flex-start;
    }

    .video-wrapper {
        width: 100%;
        max-width:100%;
        border-radius: 0;
        aspect-ratio: 16 / 9;
    }

    #sidebar {
        position: fixed;
        width: 280px;
        height: 100%;
        left: -280px;
        top: 0;
        transition: 0.3s;
        z-index: 150;
    }

    #sidebar.active {
        left: 0;
    }

    #menuBtn {
        display: block;
    }

    #overlay.active {
        display: block;
    }
}
</style>
</head>

<body>

<button id="menuBtn">â˜°</button>
<div id="overlay"></div>

<div id="sidebar">
    <input type="text" id="search" placeholder="Search channels...">
    <div id="channels"></div>
</div>

<div id="main">
    <div class="player-container">
        <h1 class="app-title">TIRI PISO WIFI IPTV</h1>

        <div class="video-wrapper">
            <video id="video" autoplay muted playsinline></video>
            <div class="custom-controls">
                <button id="muteBtn">ðŸ”Š</button>
                <button id="fullscreenBtn">â›¶</button>
            </div>
        </div>
        <div id="epgContainer">
            <div id="epgNow"></div>
            <div id="epgNext"></div>
        </div>
    </div>
</div>


<script>
const PLAYLIST_URL = "https://premiumiptv.tiri-piso-wifi.workers.dev/playlist?token=mysecret123";
const EPG_URL = "https://premiumiptv.tiri-piso-wifi.workers.dev/epg?token=mysecret123";

let epgData = null;
const video = document.getElementById('video');
const player = new shaka.Player(video);

const sidebar = document.getElementById('sidebar');
const overlay = document.getElementById('overlay');
const menuBtn = document.getElementById('menuBtn');
const channelsDiv = document.getElementById('channels');
const searchInput = document.getElementById('search');

let channels = [];
let selectedIndex = 0;

/* =========================================
   ðŸ”¥ REDIRECT DETECTION (SESSION UPDATE)
========================================= */
player.getNetworkingEngine().registerResponseFilter((type, response) => {

    if (type === shaka.net.NetworkingEngine.RequestType.MANIFEST) {

        const finalUrl = response.uri;

        console.log("Original URL:", channels[selectedIndex]?.originalUrl);
        console.log("Redirected URL:", finalUrl);

        // Show on screen (optional)
        document.getElementById("epgNext").textContent =
            "Redirected URL: " + finalUrl;

        if (channels[selectedIndex] && finalUrl) {
            channels[selectedIndex].url = finalUrl;
        }
    }

});

/* =========================================
   ðŸ”¥ AUTO RECOVER IF SESSION EXPIRES
========================================= */
player.addEventListener('error', async (event) => {

    const current = channels[selectedIndex];
    if (!current) return;

    console.log("Player error:", event.detail);

    // 1002 = network error
    // 3016 = forbidden
    if (event.detail.code === 1002 || event.detail.code === 3016) {

        console.log("Session expired â†’ Reverting to original URL");

        current.url = current.originalUrl; // reset

        await playChannel(selectedIndex);
    }

});

/* =========================================
   MENU
========================================= */
menuBtn.onclick = () => {
    sidebar.classList.toggle('active');
    overlay.classList.toggle('active');
};

overlay.onclick = () => {
    sidebar.classList.remove('active');
    overlay.classList.remove('active');
};

/* =========================================
   LOAD PLAYLIST
========================================= */
async function loadPlaylist() {
    const res = await fetch(PLAYLIST_URL);
    const text = await res.text();
    parseM3U(text);
}

/* =========================================
   LOAD EPG
========================================= */
async function loadEPG() {
    const res = await fetch(EPG_URL);
    const text = await res.text();
    const parser = new DOMParser();
    epgData = parser.parseFromString(text, "text/xml");
}

loadEPG();

/* =========================================
   PARSE M3U
========================================= */
function parseM3U(data) {

    const lines = data.split('\n');
    let currentChannel = null;

    lines.forEach(line => {

        line = line.trim();

        if (line.startsWith('#EXTINF')) {

            const name = line.split(',')[1] || "Channel";
            const groupMatch = line.match(/group-title="(.*?)"/);
            const logoMatch = line.match(/tvg-logo="(.*?)"/);
            const idMatch = line.match(/tvg-id="(.*?)"/);

            if (!groupMatch || groupMatch[1].toLowerCase() === "other") {
                currentChannel = null;
                return;
            }

            currentChannel = {
                name,
                group: groupMatch[1],
                logo: logoMatch ? logoMatch[1] : "",
                tvgId: idMatch ? idMatch[1] : "",
                keyId: "",
                key: "",
                url: "",
                originalUrl: ""
            };
        }

        else if (line.includes('license_key') && currentChannel) {
            const keys = line.split('=')[1].split(':');
            currentChannel.keyId = keys[0];
            currentChannel.key = keys[1];
        }

        else if (line && !line.startsWith('#') && currentChannel) {
            currentChannel.url = line;
            currentChannel.originalUrl = line;
            channels.push(currentChannel);
            currentChannel = null;
        }

    });

    renderChannels();

    if (channels.length > 0) {
        setTimeout(() => playChannel(0), 300);
    }
}

/* =========================================
   RENDER CHANNELS
========================================= */
function renderChannels(filter = "") {

    channelsDiv.innerHTML = "";
    let lastGroup = "";

    const filtered = channels.filter(c =>
        c.name.toLowerCase().includes(filter.toLowerCase())
    );

    filtered.forEach((c) => {

        if (c.group !== lastGroup) {
            let groupTitle = document.createElement('div');
            groupTitle.className = "group-title";
            groupTitle.innerText = c.group;
            channelsDiv.appendChild(groupTitle);
            lastGroup = c.group;
        }

        let div = document.createElement('div');
        div.className = "channel";
        div.innerHTML = `
            ${c.logo ? `<img src="${c.logo}">` : ""}
            <span>${c.name}</span>
        `;

        div.onclick = () => playChannelByObject(c);
        channelsDiv.appendChild(div);
    });
}

/* =========================================
   RESOLVE STREAM URL
========================================= */
function resolveStreamUrl(channel) {
function resolveStreamUrl(channel) {
    if (channel.url.startsWith("http://")) {
        const encoded = encodeURIComponent(channel.url);
        return window.location.origin + "/proxy?url=" + encoded;
    }
    return channel.url;
}
/* =========================================
   PLAY CHANNEL
========================================= */
async function playChannelByObject(channel) {

    selectedIndex = channels.indexOf(channel);

    document.querySelectorAll('.channel').forEach(el => el.classList.remove('active'));

    await player.unload();

    player.configure({
        drm: {
            clearKeys: channel.keyId ? {
                [channel.keyId]: channel.key
            } : {}
        }
    });

    await player.load(resolveStreamUrl(channel));

    updateEPG(channel);
}

async function playChannel(index) {

    selectedIndex = index;
    const c = channels[index];

    document.querySelectorAll('.channel').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.channel')[index]?.classList.add('active');

    sidebar.classList.remove('active');
    overlay.classList.remove('active');

    await player.unload();

    player.configure({
        drm: {
            clearKeys: c.keyId ? {
                [c.keyId]: c.key
            } : {}
        }
    });

    await player.load(resolveStreamUrl(c));

    updateEPG(c);
}

/* =========================================
   SEARCH
========================================= */
searchInput.addEventListener("input", e => {
    renderChannels(e.target.value);
});

/* =========================================
   KEYBOARD NAVIGATION
========================================= */
document.addEventListener("keydown", e => {

    if (e.key === "ArrowDown") {
        selectedIndex = (selectedIndex + 1) % channels.length;
        playChannel(selectedIndex);
    }

    if (e.key === "ArrowUp") {
        selectedIndex = (selectedIndex - 1 + channels.length) % channels.length;
        playChannel(selectedIndex);
    }

});

loadPlaylist();

/* =========================================
   CONTROLS
========================================= */
const muteBtn = document.getElementById("muteBtn");
const fullscreenBtn = document.getElementById("fullscreenBtn");

muteBtn.addEventListener("click", () => {
    video.muted = !video.muted;
    muteBtn.textContent = video.muted ? "ðŸ”‡" : "ðŸ”Š";
});

fullscreenBtn.addEventListener("click", () => {
    const wrapper = document.querySelector(".video-wrapper");

    if (!document.fullscreenElement) {
        wrapper.requestFullscreen();
    } else {
        document.exitFullscreen();
    }
});
</script>



</body>
</html>




















































